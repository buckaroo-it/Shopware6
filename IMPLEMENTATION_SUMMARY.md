# Implementation Summary: Shopware 6.7 Asset Compatibility Fix

## Overview

This document summarizes the implementation of a better solution for handling static assets across Shopware 6.6.x and 6.7+ versions.

## The Problem

- **Shopware < 6.7**: Expects admin static assets at `public/bundles/[plugin]/administration/static/`
- **Shopware >= 6.7**: Expects admin static assets at `public/bundles/[plugin]/static/`
- Running `bin/build-administration.sh` removes files from one location or the other
- Previous solution: Manually maintain duplicate files in both locations

## The Solution Implemented

### 1. **Source of Truth**

Created a single source location for all static assets:
```
src/Resources/app/administration/static/
```

All SVG icons and static images should be placed here. This is version-controlled and the canonical source.

### 2. **Automated Asset Copying**

Created `bin/copy-admin-static-assets.php` script that:
- Reads from the source directory
- Copies to BOTH public locations for compatibility:
  - `src/Resources/public/administration/static/` (Shopware < 6.7)
  - `src/Resources/public/static/` (Shopware >= 6.7)

### 3. **Composer Integration**

Added a `post-build` script to `composer.json`:
```json
"scripts": {
    "post-build": [
        "php bin/copy-admin-static-assets.php"
    ]
}
```

Run with: `composer run post-build`

### 4. **Runtime Version Detection**

The JavaScript code already implements version detection (kept as-is):
- Detects Shopware version at runtime
- Uses the appropriate asset path
- Located in: `src/Resources/app/administration/src/components/buckaroo-payment-list/index.js`

### 5. **Migration Script**

Created `bin/organize-static-assets.php` for one-time migration:
- Moves existing files from `public/` to source location
- Safe to run (doesn't overwrite existing files)

## Files Created/Modified

### New Files:
1. `bin/copy-admin-static-assets.php` - Asset copying script
2. `bin/post-build.sh` - Shell wrapper for post-build tasks
3. `bin/organize-static-assets.php` - One-time migration script
4. `SHOPWARE_VERSION_COMPATIBILITY.md` - Comprehensive documentation
5. `IMPLEMENTATION_SUMMARY.md` - This file

### Modified Files:
1. `composer.json` - Added `post-build` script
2. `src/Resources/app/administration/src/components/buckaroo-payment-list/index.js` - Updated path comment

## Migration Steps (For First Time)

### Step 1: Organize Existing Assets

If you currently have files in `public/` directories, run the migration script:

```bash
php bin/organize-static-assets.php
```

This moves files to the source location without duplicating.

### Step 2: Create Source Directory Structure

If starting fresh or if the source directory doesn't exist:

```bash
mkdir -p src/Resources/app/administration/static
```

Copy all your SVG files to this directory.

### Step 3: Run Post-Build

```bash
composer run post-build
```

This copies assets to both public locations.

### Step 4: Update .gitignore (Recommended)

Add these lines to `.gitignore` to treat public directories as build artifacts:

```gitignore
# Build artifacts - generated by post-build scripts
src/Resources/public/administration/static/
src/Resources/public/static/
src/Resources/public/administration/.vite/
src/Resources/public/administration/assets/
src/Resources/public/administration/css/
src/Resources/public/administration/js/
```

## Ongoing Workflow

### When Adding New Assets:

1. Add file to `src/Resources/app/administration/static/`
2. Run `composer run post-build`
3. Commit only the source file, not the copies in `public/`

### When Building Administration:

```bash
# In Shopware root
bin/build-administration.sh

# In plugin directory
cd custom/plugins/BuckarooPayments
composer run post-build
```

### When Deploying to Client:

```bash
# Install plugin
bin/console plugin:refresh
bin/console plugin:install BuckarooPayments --activate

# Install assets
bin/console assets:install

# Clear cache
bin/console cache:clear
```

## Advantages of This Approach

✅ **Single Source of Truth**: All assets in one location
✅ **Automated**: No manual file copying
✅ **Version Compatible**: Works with Shopware 6.5, 6.6, and 6.7+
✅ **Maintainable**: Clear separation between source and build artifacts
✅ **Portable**: Works in any client environment
✅ **Standard**: Follows Shopware best practices

## Technical Details

### How Version Detection Works

```javascript
isShopware67OrNewer() {
    const version = Shopware.Context.app.config.version || '';
    const versionParts = version.split('.');
    const majorVersion = parseInt(versionParts[0], 10);
    const minorVersion = parseInt(versionParts[1], 10);
    return majorVersion > 6 || (majorVersion === 6 && minorVersion >= 7);
}
```

### Asset Path Resolution

- **Shopware < 6.7**: `bundles/buckaroopayments/administration/static/[filename]`
- **Shopware >= 6.7**: `buckaroopayments/static/[filename]`

The Shopware asset filter (`assetFilter`) automatically resolves to the correct full path.

## Troubleshooting

### Assets Not Loading

1. Check browser console for 404 errors
2. Verify files exist in both public locations: `composer run post-build`
3. Run `bin/console assets:install`
4. Clear browser cache and Shopware cache

### Wrong Path Being Used

1. Check Shopware version detection in browser console
2. Verify version logic in `isShopware67OrNewer` computed property
3. Check that asset filter is being called correctly

### Files Missing After Build

This is expected! Run `composer run post-build` after each administration build.

## Future Improvements (Optional)

1. **Pre-commit Hook**: Automatically run post-build before commits
2. **CI/CD Integration**: Run post-build in deployment pipeline
3. **Webpack/Vite Plugin**: Automate copying during build process
4. **Version Detection Enhancement**: Add fallback detection methods

## References

- [Shopware 6.7 Administration Assets Documentation](https://developer.shopware.com/docs/guides/plugins/plugins/administration/using-assets.html)
- [Shopware 6.6 Administration Assets Documentation](https://developer.shopware.com/docs/v6.6/guides/plugins/plugins/administration/templates-styling/using-assets.html)
- `SHOPWARE_VERSION_COMPATIBILITY.md` - Detailed compatibility guide

## Contact

For questions or issues related to this implementation, refer to the plugin's main README or contact the development team.

